version: "3.9"

services:
  postgres:
    image: postgres:16.6
    container_name: erp_postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports:
      - "5435:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  mongo:
    image: mongo:6.0
    container_name: erp_mongo
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
    ports:
      - "27017:27017"
    volumes:
      - mongodata:/data/db

  redis:
    image: redis:latest
    container_name: erp_redis
    restart: unless-stopped
    ports:
      - "6380:6379"

  nest-api:
    build: ./backend/nestjs
    container_name: erp_nest
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - NEST_PORT=${NEST_PORT}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - MONGO_URL=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:27017/?authSource=admin
      - MONGO_DB=${MONGO_DB}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CORS_ORIGIN=${CORS_ORIGIN}
    depends_on:
      - postgres
      - mongo
      - redis
    ports:
      - "3000:3000"

  fastapi-crm:
    build: ./backend/fastapi
    container_name: erp_fastapi
    restart: unless-stopped
    environment:
      - UVICORN_PORT=${FASTAPI_PORT}
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - CORS_ORIGIN=${CORS_ORIGIN}
      - MONGO_URL=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:27017/?authSource=admin
      - MONGO_DB=${MONGO_DB}
      - LOCAL_EXTRACTED_DATA_PATH=/app/extracted_data
    depends_on:
      - postgres
    ports:
      - "8001:8000"
    volumes:
      - ./backend/extracted_data:/app/extracted_data

  nginx:
    image: nginx:latest
    container_name: erp_nginx
    restart: unless-stopped
    depends_on:
      - nest-api
      - fastapi-crm
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro

  n8n:
    image: n8nio/n8n:latest
    container_name: erp_n8n
    restart: unless-stopped
    environment:
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n

  pdf-extractor:
    build:
      context: ./backend
      dockerfile: ./extractor/Dockerfile
    container_name: erp_pdf_extractor
    restart: "no"
    environment:
      - TZ=America/Sao_Paulo
      - MONGO_URL=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:27017/?authSource=admin
      - MONGO_DB=${MONGO_DB}
    volumes:
      - ./backend/extracted_data:/app/extractor/extracted_data

volumes:
  pgdata:
  mongodata:
  n8n_data: